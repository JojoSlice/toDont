name: Build API on PR

on:
  pull_request:
    paths:
      - "**.cs"
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: RÃ¤kna Ã¤ndrade C# filer och rader
        id: stats
        shell: bash
        run: |
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.cs$' | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

          CHANGED_LINES=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | grep '\.cs$' | awk '{sum+=$1+$2} END {print sum}')
          echo "changed_lines=${CHANGED_LINES:-0}" >> $GITHUB_OUTPUT

      - name: Visa statistik
        shell: bash
        run: |
          echo "ðŸ“Š Statistik fÃ¶r C# filer:"
          echo "================================"
          echo "Ã„ndrade filer: ${{ steps.stats.outputs.changed_files }}"
          echo "Ã„ndrade rader: ${{ steps.stats.outputs.changed_lines }}"
          echo "================================"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/AppData/Local/NuGet/v3-cache
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ./Api/Api.csproj

      - name: Build with Code Analysis
        run: dotnet build ./Api/Api.csproj --configuration Release --no-restore /p:TreatWarningsAsErrors=true

      - name: Byggresultat
        if: success()
        shell: bash
        run: |
          echo "âœ… Build lyckades pÃ¥ ${{ matrix.os }}!"
          echo "Ã„ndrade ${{ steps.stats.outputs.changed_files }} filer med ${{ steps.stats.outputs.changed_lines }} rader"

      - name: Kommentera pÃ¥ PR
        if: success() && matrix.os == 'ubuntu-latest'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“Š Build Statistik\n\n` +
                    `âœ… Build lyckades pÃ¥ bÃ¥de Windows och Linux!\n\n` +
                    `### Ã„ndringar i denna PR:\n` +
                    `- **Ã„ndrade .cs filer:** ${{ steps.stats.outputs.changed_files }}\n` +
                    `- **Ã„ndrade rader:** ${{ steps.stats.outputs.changed_lines }}\n\n` +
                    `âœ¨ Code analysis: Inga varningar eller fel`
            })
